# MCP Learning System Makefile

.PHONY: help build test clean deploy benchmark docs lint

# Default target
help:
	@echo "MCP Learning System Build Commands"
	@echo "=================================="
	@echo ""
	@echo "Build commands:"
	@echo "  build           Build all components"
	@echo "  build-rust      Build Rust core"
	@echo "  build-python    Build Python learning layer"
	@echo "  build-docker    Build Docker images"
	@echo ""
	@echo "Test commands:"
	@echo "  test            Run all tests"
	@echo "  test-rust       Run Rust tests"
	@echo "  test-python     Run Python tests"
	@echo "  test-integration Run integration tests"
	@echo "  benchmark       Run performance benchmarks"
	@echo ""
	@echo "Development commands:"
	@echo "  dev             Start development environment"
	@echo "  lint            Run linters on all code"
	@echo "  format          Format all code"
	@echo "  clean           Clean build artifacts"
	@echo ""
	@echo "Deployment commands:"
	@echo "  deploy          Deploy to production"
	@echo "  deploy-dev      Deploy to development"
	@echo "  health-check    Check system health"
	@echo ""
	@echo "Documentation:"
	@echo "  docs            Generate documentation"
	@echo "  docs-serve      Serve documentation locally"

# Variables
RUST_DIR := rust_core
PYTHON_DIR := python_learning
DOCKER_COMPOSE := docker-compose
DOCKER_COMPOSE_DEV := docker-compose -f docker-compose.dev.yml
DOCKER_COMPOSE_PROD := docker-compose -f docker-compose.prod.yml

# Build targets
build: build-rust build-python
	@echo "âœ… All components built successfully"

build-rust:
	@echo "ğŸ¦€ Building Rust core..."
	cd $(RUST_DIR) && cargo build --release
	@echo "âœ… Rust core built"

build-python:
	@echo "ğŸ Building Python learning layer..."
	cd $(PYTHON_DIR) && poetry build
	@echo "âœ… Python learning layer built"

build-docker:
	@echo "ğŸ³ Building Docker images..."
	$(DOCKER_COMPOSE) build
	@echo "âœ… Docker images built"

# Test targets
test: test-rust test-python test-integration
	@echo "âœ… All tests passed"

test-rust:
	@echo "ğŸ¦€ Running Rust tests..."
	cd $(RUST_DIR) && cargo test --release
	@echo "âœ… Rust tests passed"

test-python:
	@echo "ğŸ Running Python tests..."
	cd $(PYTHON_DIR) && poetry run pytest --cov=mcp_learning tests/
	@echo "âœ… Python tests passed"

test-integration:
	@echo "ğŸ”— Running integration tests..."
	$(DOCKER_COMPOSE) -f docker-compose.test.yml up --build --abort-on-container-exit
	$(DOCKER_COMPOSE) -f docker-compose.test.yml down
	@echo "âœ… Integration tests passed"

benchmark:
	@echo "âš¡ Running performance benchmarks..."
	cd $(RUST_DIR) && cargo bench
	cd $(PYTHON_DIR) && poetry run pytest --benchmark-only tests/
	@echo "âœ… Benchmarks completed"

# Development targets
dev:
	@echo "ğŸš€ Starting development environment..."
	$(DOCKER_COMPOSE_DEV) up --build

dev-down:
	@echo "ğŸ›‘ Stopping development environment..."
	$(DOCKER_COMPOSE_DEV) down

# Code quality targets
lint: lint-rust lint-python
	@echo "âœ… All linting passed"

lint-rust:
	@echo "ğŸ¦€ Linting Rust code..."
	cd $(RUST_DIR) && cargo clippy -- -D warnings
	@echo "âœ… Rust linting passed"

lint-python:
	@echo "ğŸ Linting Python code..."
	cd $(PYTHON_DIR) && poetry run ruff check .
	cd $(PYTHON_DIR) && poetry run mypy mcp_learning/
	@echo "âœ… Python linting passed"

format: format-rust format-python
	@echo "âœ… All code formatted"

format-rust:
	@echo "ğŸ¦€ Formatting Rust code..."
	cd $(RUST_DIR) && cargo fmt
	@echo "âœ… Rust code formatted"

format-python:
	@echo "ğŸ Formatting Python code..."
	cd $(PYTHON_DIR) && poetry run black .
	@echo "âœ… Python code formatted"

# Deployment targets
deploy: build-docker
	@echo "ğŸš€ Deploying to production..."
	$(DOCKER_COMPOSE_PROD) up -d
	@echo "âœ… Production deployment complete"

deploy-dev: build-docker
	@echo "ğŸš€ Deploying to development..."
	$(DOCKER_COMPOSE_DEV) up -d
	@echo "âœ… Development deployment complete"

health-check:
	@echo "ğŸ¥ Checking system health..."
	@curl -f http://localhost:8080/health || (echo "âŒ Rust core health check failed" && exit 1)
	@curl -f http://localhost:8000/health || (echo "âŒ Python learning health check failed" && exit 1)
	@curl -f http://localhost:9090/-/healthy || (echo "âŒ Prometheus health check failed" && exit 1)
	@echo "âœ… All health checks passed"

# Documentation targets
docs:
	@echo "ğŸ“š Generating documentation..."
	cd $(RUST_DIR) && cargo doc --no-deps
	cd $(PYTHON_DIR) && poetry run sphinx-build -b html docs/ docs/_build/
	@echo "âœ… Documentation generated"

docs-serve:
	@echo "ğŸ“š Serving documentation..."
	cd $(PYTHON_DIR)/docs/_build && python -m http.server 8080

# Utility targets
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd $(RUST_DIR) && cargo clean
	cd $(PYTHON_DIR) && rm -rf dist/ .pytest_cache/ .coverage
	$(DOCKER_COMPOSE) down --rmi local --volumes
	@echo "âœ… Cleanup complete"

install-deps:
	@echo "ğŸ“¦ Installing dependencies..."
	cd $(RUST_DIR) && cargo fetch
	cd $(PYTHON_DIR) && poetry install
	@echo "âœ… Dependencies installed"

setup-dev:
	@echo "ğŸ› ï¸ Setting up development environment..."
	./scripts/install-git-hooks.sh
	./scripts/setup-dev-env.sh
	@echo "âœ… Development environment setup complete"

# Security targets
security-scan:
	@echo "ğŸ”’ Running security scans..."
	cd $(RUST_DIR) && cargo audit
	cd $(PYTHON_DIR) && poetry run safety check
	cd $(PYTHON_DIR) && poetry run bandit -r mcp_learning/
	@echo "âœ… Security scans complete"

# Performance targets
profile-rust:
	@echo "âš¡ Profiling Rust performance..."
	cd $(RUST_DIR) && cargo build --release
	cd $(RUST_DIR) && perf record --call-graph=dwarf target/release/mcp-learning-core
	cd $(RUST_DIR) && perf report
	@echo "âœ… Rust profiling complete"

profile-python:
	@echo "âš¡ Profiling Python performance..."
	cd $(PYTHON_DIR) && poetry run python -m cProfile -o profile.stats scripts/benchmark.py
	cd $(PYTHON_DIR) && poetry run python -c "import pstats; pstats.Stats('profile.stats').sort_stats('tottime').print_stats(20)"
	@echo "âœ… Python profiling complete"

# Database targets
db-migrate:
	@echo "ğŸ’¾ Running database migrations..."
	$(DOCKER_COMPOSE) exec python-learning poetry run alembic upgrade head
	@echo "âœ… Database migrations complete"

db-reset:
	@echo "ğŸ’¾ Resetting database..."
	$(DOCKER_COMPOSE) exec python-learning poetry run alembic downgrade base
	$(DOCKER_COMPOSE) exec python-learning poetry run alembic upgrade head
	@echo "âœ… Database reset complete"

# Monitoring targets
logs:
	@echo "ğŸ“‹ Showing logs..."
	$(DOCKER_COMPOSE) logs -f --tail=100

logs-rust:
	@echo "ğŸ“‹ Showing Rust core logs..."
	$(DOCKER_COMPOSE) logs -f rust-core

logs-python:
	@echo "ğŸ“‹ Showing Python learning logs..."
	$(DOCKER_COMPOSE) logs -f python-learning

metrics:
	@echo "ğŸ“Š Showing metrics..."
	@curl -s http://localhost:9090/api/v1/query?query=up | jq '.'

# Release targets
release-patch:
	@echo "ğŸ·ï¸ Creating patch release..."
	./scripts/release.sh patch

release-minor:
	@echo "ğŸ·ï¸ Creating minor release..."
	./scripts/release.sh minor

release-major:
	@echo "ğŸ·ï¸ Creating major release..."
	./scripts/release.sh major

# Backup targets
backup:
	@echo "ğŸ’¾ Creating backup..."
	./scripts/backup.sh

restore:
	@echo "ğŸ’¾ Restoring from backup..."
	./scripts/restore.sh $(BACKUP_FILE)

# Load testing
load-test:
	@echo "âš¡ Running load tests..."
	./scripts/load-test.sh

stress-test:
	@echo "ğŸ’¥ Running stress tests..."
	./scripts/stress-test.sh